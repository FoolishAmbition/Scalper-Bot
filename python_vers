import time
from playwright.sync_api import sync_playwright

bought = 0

while bought < 1:
    with sync_playwright() as p:
        # Launch browser
        browser = p.chromium.launch(headless=True)  # Set `True` to run headless
        context = browser.new_context()
        page = context.new_page()
        print("new blank page loaded")

        # Block images for faster loading
        context.route("**/*", lambda route: route.abort() if "image" in route.request.resource_type else route.continue_())
        print("blocked images from appearing for fast loading")

        # Navigate to the BestBuy product page
        page.goto("https://www.bestbuy.com/site/xgimi-halo-1080p-hdr-smart-portable-projector-with-harman-kardon-speaker-2-5h-built-in-battery-and-android-tv-silver/6518392.p?skuId=6518392")
        print("page directed to bestbuy link")

        # Handle region selection (if applicable)
        try:
            # Use a more specific locator to target the correct "United States" link
            us_link = page.locator("a.us-link:has-text('United States')").first
            if us_link.is_visible(timeout=5000):  # Adjust timeout as necessary
                us_link.click()
                print("Clicked on 'United States' region")
                time.sleep(3)  # Wait for the page to reload
        except Exception as e:
            print("Region selection not required or failed:", e)

        buy_button_available = False

        while not buy_button_available:
            try:
                # Check if "Add to Cart" button is disabled
                if page.locator(".btn-disabled").is_visible():
                    t = time.strftime("%H:%M:%S", time.localtime())
                    print(t + " Add-to-cart button is not ready yet.")
                    time.sleep(15)
                    page.reload()
                else:
                    # "Add to Cart" button is available
                    print("Add-to-cart button available.")
                    page.locator(".fulfillment-add-to-cart-button").click()
                    print("Add-to-cart button was clicked.")
                    buy_button_available = True
            except Exception as e:
                print(f"Error while checking the add-to-cart button: {e}")
                page.screenshot(path="error_screenshot.png")
                print("Screenshot saved as error_screenshot.png")
                page.reload()

        # Go to cart
        try:
            page.wait_for_selector(".go-to-cart-button", timeout=10000)  # Wait for up to 10 seconds
            page.locator(".go-to-cart-button").click()  # Click on the "Go to Cart" button
            print("Go-to-cart button was clicked.")
        except Exception as e:
            print(f"Error while clicking 'Go to Cart' button: {e}")
            page.screenshot(path="go_to_cart_error_screenshot.png")  # Capture screenshot on error
            print("Screenshot saved as go_to_cart_error_screenshot.png")
            page.reload()  # Optionally reload the page and continue


        # Continue to checkout
        page.wait_for_selector(".checkout-buttons__checkout").click()
        print("Checkout button was clicked.")

        # Continue as guest
        page.wait_for_selector(".button-wrap").click()
        print("Continue-as-guest button was clicked.")

        # Fill in email and phone number
        page.fill("#user\\.emailAddress", "your_email@gmail.com")
        print("Email input in the form.")
        page.fill("#user\\.phone", "123456789")
        print("Phone input in the form.")

        # Continue to payment
        page.locator(".button--continue").click()
        print("Continue-to-payment-information button was clicked.")

        # Enter credit card information
        page.fill("#optimized-cc-card-number", "1234567890123456")
        page.fill("[name='expiration-month']", "01")
        page.fill("[name='expiration-year']", "25")
        page.fill("#credit-card-cvv", "999")
        print("Credit card information input in the form.")

        # Enter billing address
        page.fill("#payment\\.billingAddress\\.firstName", "Ming Shun")
        page.fill("#payment\\.billingAddress\\.lastName", "Ong")
        page.fill("#payment\\.billingAddress\\.street", "BoonLay")
        page.fill("#payment\\.billingAddress\\.city", "Singapore")
        page.fill("#payment\\.billingAddress\\.state", "Singapore")
        page.fill("#payment\\.billingAddress\\.zipcode", "051732")
        print("Billing Address input in the form.")
